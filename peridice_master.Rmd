---
title: "peridice_master"
author: "Iris Kern"
date: "2023-11-03"
output: html_document
---

# Setup
## Libraries
```{r}
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(plotly)
library(vegan)
library(heatmaply)
library(ggnewscale)
library(readr)
library(readxl)
library(corrr)
library(ggcorrplot)
library(FactoMineR)
library(stats)
library(ggfortify)

set.seed(20)
```

## Datasets - metabolites and metadata
```{r}
quant_data <- read_csv("csvs/quant_data.csv") %>% 
  filter(nM > 0) %>% 
  filter(nM < 100)
  
metadataframe <- read_csv("csvs/metadataframe.csv")
pcpn <- read_xlsx("metadata/peridice_pcpn.xlsx") %>% 
  select(tank = Tank, treatment = Treatment2, date = Date, pn = `PN (uM)`, pc = `PC (uM)`, cn = Cnratio,added_N_uM = AddN) %>% 
  mutate(triplicate = str_extract(tank, "\\d"))
  
```

## ESS Project
```{r}
metab_pcpn <- data_vis %>%
  left_join(pcpn) %>%
  select(-c("tank")) %>%
  mutate(nmol_per_pc = nM/pc) %>%
  select(metabolite, treatment, date, triplicate,filename = replicate, nmol = nM, pc, pn, nmol_per_pc, added_N_uM)

g1_metab_data <- read_csv("csvs/G1_Metab_Data.csv")

  filter(metabolite %in% g1_metab_data$Complete_compound_name) %>%
  group_by(treatment, triplicate, date)

write.csv(metab_pcpn_filt, "PERIDICE_metabolite_data.csv", row.names = FALSE)
 
```


## Wrangle and setup
```{r}
data_vis <- quant_data %>%  
  mutate(treatment = str_extract(replicate, "Std|Poo|Blk|C|ZF|ZL|ZH|RL|RH|LL|LH|Tote")) %>% 
  mutate(timepoint = str_extract(replicate, "27June|30June|14July|21July|27July")) %>% 
  mutate(timepoint = str_replace_all(timepoint, "July", "-7-22")) %>% 
  mutate(timepoint = str_replace_all(timepoint, "June", "-6-22")) %>% 
  mutate(date = as.Date(timepoint, format = "%d-%m-%y")) %>% 
  select(metabolite, treatment, date, nM, replicate) %>% 
  filter(metabolite != "Sodium 2-mercaptoethanesulfonate") %>% 
  filter(metabolite != "Fumaric acid") %>% 
  na.omit() %>% 
  mutate(triplicate = str_extract(replicate, "\\d$"))

level_order <- c("T0", "C", "ZF", "ZL", "ZH", "LL", "LH", "RL", "RH")

heat_level_order_treat <- c("2022-06-27 Tote", "2022-06-30 C",  "2022-07-14 C",  "2022-07-21 C",  "2022-07-27 C",  
                            "2022-06-30 ZF", "2022-07-14 ZF", "2022-07-21 ZF", "2022-07-27 ZF",
                            "2022-06-30 ZL", "2022-07-14 ZL", "2022-07-21 ZL", "2022-07-27 ZL", 
                            "2022-06-30 ZH", "2022-07-14 ZH", "2022-07-21 ZH", "2022-07-27 ZH",
                            "2022-06-30 LL", "2022-07-14  LL", "2022-07-21 LL", "2022-07-27 LL",
                            "2022-06-30 LH", "2022-07-14 LH", "2022-07-21 LH", "2022-07-27 LH", 
                            "2022-06-30 RL", "2022-07-14 RL", "2022-07-21 RL", "2022-07-27 RL",
                            "2022-06-30 RH", "2022-07-14 RH", "2022-07-21 RH", "2022-07-27 RH")

heat_level_order_date <- c("2022-06-27 Tote", "2022-06-30 C","2022-06-30 ZF", "2022-06-30 ZL", 
                           "2022-06-30 ZH", "2022-06-30 LL","2022-06-30 LH", "2022-06-30 RL", "2022-06-30 RH",
                           "2022-07-14 C", "2022-07-14 ZF", "2022-07-14 ZL", "2022-07-14 ZH", "2022-07-14 LL", 
                           "2022-07-14 LH", "2022-07-14 RL", "2022-07-14 RH", 
                           "2022-07-21 C", "2022-07-21 ZF", "2022-07-21 ZL", "2022-07-21 ZH", 
                           "2022-07-21 LL", "2022-07-21 LH", "2022-07-21 RL", "2022-07-21 RH", 
                           "2022-07-27 C", "2022-07-27 ZF", "2022-07-27 ZL",  
                           "2022-07-27 ZH", "2022-07-27 LL", "2022-07-27 LH", "2022-07-27 RL",  "2022-07-27 RH")
```

# Metadata overview
```{r}
pcpn %>% 
  mutate(cn_rank=(cn-min(cn))/(max(cn)-min(cn))) %>%
  filter(str_detect(treatment, "RH|RL|LH|LL|C")) %>% 
  group_by(triplicate, treatment, date) %>%  
  # mutate(avg_cn = mean(cn)) %>% 
  # filter(triplicate == 2) %>% 
  ggplot(aes(x = date, y = cn, group = interaction(treatment, triplicate), color = treatment)) +
  geom_line() + 
  geom_point() + 
  # scale_color_manual(values = c("plum2", "gold", "lightcoral", "darkorange", "brown3"), name = "Treatment") +
  facet_wrap(~treatment) + 
  theme_bw() +  
  ylab("C to N Ratio") + 
  xlab("Date")

pcpn %>% 
  mutate(pc_rank=(pc-min(pc))/(max(pc)-min(pc))) %>%
  filter(!str_detect(treatment, "Tote")) %>% 
  group_by(triplicate, treatment, date) %>%  
  # mutate(avg_cn = mean(cn)) %>% 
  # filter(triplicate == 2) %>% 
  ggplot(aes(x = date, y = pc, group = interaction(treatment, triplicate), color = treatment)) +
  geom_line() + 
  geom_point() + 
  # scale_color_manual(values = c("plum2", "gold", "lightcoral", "darkorange", "brown3"), name = "Treatment") +
  facet_wrap(~treatment, scales = "free") + 
  theme_bw() +  
  ylab("Particulate Carbon") + 
  xlab("Date")
```

# Statistical Distributions
## Heatmap
```{r}
quant_nmds_heat <- data_vis %>% 
  group_by(metabolite, treatment, date) %>%
  summarise(avg_nmol = mean(nM)) %>%
  ungroup() %>%
  mutate(id = paste(date, treatment)) 
# %>% 
#   filter(str_detect(treatment, "RH|RL|LH|LL"))

heatmap_data <- quant_nmds_heat %>% 
  # group_by(metabolite) %>%
  # filter(str_detect(treatment, "RH|RL|C|Tote")) %>% 
  # filter(avg_nmol >= 0.01) %>% 
  complete(metabolite, id, fill = list(avg_nmol = 0)) %>% 
  group_by(metabolite) %>% 
  mutate(norm_conc = rank(avg_nmol)) %>%
  # mutate(norm_conc=scale(avg_nmol)[,1]) %>%
  select(metabolite, norm_conc, id) %>%
  pivot_wider(names_from = "metabolite", values_from = "norm_conc") %>%
  mutate(id=factor(id, levels=c(heat_level_order_treat))) %>%
  arrange(id) %>%
  na.omit() %>% 
  column_to_rownames("id")


plotheatmap <- heatmap_data %>%
  data.matrix() %>% 
  # heatmaply(fontsize_row = 10, fontsize_col = 7) %>%
  heatmaply(Rowv = FALSE, fontsize_row = 10, fontsize_col = 7)

# make clustered heatmap from scratch using pheatmap

plotheatmap
```
Metabolites that die off within first 3 days - bottle effects?

## Foldchange
```{r}
data_vis_fc <- data_vis %>% 
  select(-c("replicate")) %>% 
  filter(!str_detect(treatment, "Tote")) %>% 
  pivot_wider(names_from = treatment, values_from = nM, values_fn = mean) %>% 
  pivot_longer(cols = c(ZF, ZL, ZH, LL, LH, RL, RH)) %>% 
  mutate(fold_change = value/C)
```

## K Means
```{r}
data_vis_km <- data_vis %>% 
  pivot_wider(names_from = metabolite, values_from = nM) %>% 
  select(-c("treatment", "date")) %>% 
  column_to_rownames("replicate") %>% 
  data.matrix() %>%
  `[<-`(is.na(.), 0) %>%
  scale() %>%
  t() %>%
  kmeans(centers = 6) %>% 
  pluck("cluster") %>%
  as.data.frame() %>%
  set_names("cluster") %>%
  rownames_to_column("metabolite")

data_vis_cluster <- data_vis_fc %>% 
  left_join(data_vis_km) %>% 
  rename(control = C, treatment = name, nM = value) %>% 
  mutate(cluster = factor(cluster))
```

## Second Heatmap Attempt with K Means
```{r}
ranked_conc <- quant_nmds_heat %>% 
  # group_by(metabolite) %>%
  # filter(str_detect(treatment, "RH|RL|C|Tote")) %>% 
  # filter(avg_nmol >= 0.01) %>% 
  complete(metabolite, id, fill = list(avg_nmol = 0)) %>% 
  group_by(metabolite) %>% 
  mutate(norm_conc = rank(avg_nmol)) %>%
  select(metabolite, norm_conc, id) 

ranked_conc %>% 
  ggplot() +
  geom_raster(aes(x = metabolite, y = id, fill = norm_conc)) +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) +
  scale_fill_gradient2(low = "steelblue", mid = "grey90",
                       high = "goldenrod1", midpoint = 16.5,
                       breaks=c(0, 16.5, 33), labels=c(
                         "Very little of a given compound",
                         "Median compound abundance",
                         "Compound maximum"
                       )) +
  new_scale_fill() + 
  geom_tile(aes(x=metabolite, y=-1.5, fill=cluster), height=3, data = data_vis_cluster) + 
  # scale_fill_discrete(guide="none") +
  # theme_void() +
  theme(legend.position = "top",
        legend.key.width = unit(dev.size()[1] / 6, "inches"),
        legend.text = element_text(size=8))
  # coord_cartesian(ylim=c(0, NA)) +
  # annotate("rect", xmin=-20, xmax=0, ymin=c(0.5, 4.5, 8.5, 12.5), ymax=c(4.5, 8.5, 12.5, 16.5),
  #          fill=c("#0d374f", "#367776", "#1f92d0", "lightblue2")) 
  # annotate("text", x = -11, y=c(2.5, 6.5, 10.5, 14.5), label=c("6-30", "7-14", "7-21", "7-27"),
  #          angle=90, color="white", size=6) +
  # annotate("text", x=205, y=-10, label="Metabolite", size=6) +
  # annotate("text", x=Inf, y=-10, label="k-means clusters with n=5", hjust=1) +
  # annotate("tile", x=312, y=seq(-8, -13, length.out=5), width=10, height=2,
  #          fill=hcl(h = seq(15, 375, length = 6), l = 65, c = 100)[1:5])
```





## Visualization Foldchange by Cluster
```{r}
data_vis_cluster %>% 
  na.omit() %>% 
  group_by(cluster, date, treatment) %>% 
  filter(str_detect(treatment, "RH|RL|LH|LL")) %>% 
  mutate(avg_fc = mean(fold_change)) %>% 
  ggplot(aes(x = date, y = log2(avg_fc), color = factor(treatment, levels = level_order))) + 
  geom_point() +
  geom_line() + 
  theme_bw() + 
  facet_wrap(~cluster) +
scale_color_manual(values = c("gold", "lightcoral","orange", "brown3"),
                     labels = c("6N:1P, low dose added", "6N:1P, high dose added",
                                "16N:1P, low dose added", "16N:1P, high dose added"),
                     name = "Treatment") + 
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) + 
  ylab("Average Fold Change") + 
  xlab("Date")

data_vis_cluster %>% 
  na.omit() %>% 
  group_by(cluster, date, treatment) %>% 
  # filter(str_detect(treatment, "RH|RL|LH|LL")) %>% 
  mutate(avg_fc = mean(fold_change)) %>% 
  ggplot(aes(x = date, y = log2(avg_fc), color = factor(treatment, levels = level_order))) + 
  geom_point() +
  geom_line() + 
  theme_bw() + 
  facet_wrap(~cluster) +
  scale_color_manual(values = c("mediumpurple3","darkslategray2", "lightseagreen","gold", "lightcoral","orange", "brown3"),
                     labels = c("0N:1P:1Fe, high dose P","0N:1P, low dose added", "0N:1P, high dose added",
                                "6N:1P, low dose added", "6N:1P, high dose added",
                                "16N:1P, low dose added", "16N:1P, high dose added"),
                     name = "Treatment") + 
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) + 
  ylab("Average Fold Change") + 
  xlab("Date")

```

## NMDS for just R/L Treatments
```{r}
quant_nmds <- data_vis %>% 
  # arrange(desc(nM)) %>% 
  # group_by(metabolite, replicate) %>% 
  # slice(1) %>% 
  group_by(metabolite, treatment, date) %>%
  summarise(avg_nmol = mean(nM)) %>%
  ungroup() %>%
  # complete(metabolite, date, treatment) %>%
  # mutate(avg_nmol = replace_na(avg_nmol, 0)) %>%
  mutate(id = paste(date, treatment)) %>% 
  filter(!str_detect(id, "Tote|ZF|ZH|ZL"))

quant_mat <- quant_nmds %>%
  group_by(metabolite) %>%
  mutate(norm_conc = rank(avg_nmol)) %>%
  select(metabolite, norm_conc, id) %>% 
  pivot_wider(names_from = "metabolite", values_from = "norm_conc", values_fill = 0) %>%
  column_to_rownames("id") %>%
  data.matrix() 

mdsout <- quant_mat %>%
  metaMDS(k = 2, autotransform = FALSE)

mds_data <- metadataframe %>% 
  ungroup() %>% 
  mutate(timepoint = str_replace_all(timepoint, "July", "-7-22")) %>% 
  mutate(timepoint = str_replace_all(timepoint, "June", "-6-22")) %>% 
  mutate(date = as.Date(timepoint, format = "%d-%m-%y")) %>% 
  filter(str_detect(filename, "Smp")) %>% 
  mutate(treatment = str_remove(treatment, "\\d")) %>% 
  mutate(id = paste(date, treatment))

# %>% 
#   select(-c("replicate", "filename"))

mdsout$points %>%
  as.data.frame() %>%
  rownames_to_column("id") %>%
  left_join(mds_data) %>%
  mutate(date_fct = factor(date)) %>% 
  ggplot() +
  geom_point(aes(x=MDS1, y=MDS2, color=treatment, shape = date_fct), size=4) +
  scale_color_manual(values = c("plum2", "lightcoral", "gold", "brown3", "orange", "mediumpurple3",
                                "lightseagreen", "darkslategray2"),
                     labels = c("Control - no nutrients added", "6N:1P, high dose added", "6N:1P, low dose added",
                                "16N:1P, high dose added", "16N:1P, low dose added", "0N:1P:0Fe, high dose added",
                                "0N:1P, low dose added", "0N:1P, high dose added"),
                     name = "Treatment") +
  scale_shape_discrete(name = "Date") + 
  theme_bw() + 
  ggtitle("Variation of Metabolite Concentration (nM) Across Treatments")
```


```{r}
quant_nmds <- data_vis %>% 
  # arrange(desc(nM)) %>% 
  # group_by(metabolite, replicate) %>% 
  # slice(1) %>% 
  group_by(metabolite, treatment, date) %>%
  summarise(avg_nmol = mean(nM)) %>%
  ungroup() %>%
  # complete(metabolite, date, treatment) %>%
  # mutate(avg_nmol = replace_na(avg_nmol, 0)) %>%
  mutate(id = paste(date, treatment)) %>% 
  filter(!str_detect(treatment, "Tote"))

quant_mat <- quant_nmds %>%
  group_by(metabolite) %>%
  mutate(norm_conc = rank(avg_nmol)) %>%
  select(metabolite, norm_conc, id) %>% 
  pivot_wider(names_from = "metabolite", values_from = "norm_conc", values_fill = 0) %>%
  column_to_rownames("id") %>%
  data.matrix() 

mdsout <- quant_mat %>%
  metaMDS(k = 2, autotransform = FALSE)

mds_data <- metadataframe %>% 
  ungroup() %>% 
  mutate(timepoint = str_replace_all(timepoint, "July", "-7-22")) %>% 
  mutate(timepoint = str_replace_all(timepoint, "June", "-6-22")) %>% 
  mutate(date = as.Date(timepoint, format = "%d-%m-%y")) %>% 
  filter(str_detect(filename, "Smp")) %>% 
  mutate(treatment = str_remove(treatment, "\\d")) %>% 
  mutate(id = paste(date, treatment))


mdsout$points %>%
  as.data.frame() %>%
  rownames_to_column("id") %>%
  left_join(mds_data) %>%
  mutate(date_fct = factor(date)) %>% 
  ggplot() +
  geom_point(aes(x=MDS1, y=MDS2, color=factor(treatment, levels = level_order), shape = date_fct), size=4) +
  scale_color_manual(values = c("plum2","mediumpurple3","darkslategray2", "lightseagreen","gold", "lightcoral","orange", "brown3"),
                     labels = c("Control","0N:1P:1Fe, high dose P","0N:1P, low dose added", "0N:1P, high dose added",
                                "6N:1P, low dose added", "6N:1P, high dose added",
                                "16N:1P, low dose added", "16N:1P, high dose added"),
                     name = "Treatment") +
  scale_shape_discrete(name = "Date") + 
  theme_bw() + 
  ggtitle("Variation of Metabolite Concentration (nM) Across Treatments")
```


# Data Exploration
## Line Timeseries
```{r}
data_vis %>% 
  group_by(metabolite, treatment, date) %>% 
  mutate(nmol_avg = mean(nM)) %>% 
  mutate(sd = sd(nM)) %>% 
  # slice(1) %>%
  distinct(nmol_avg, .keep_all = TRUE) %>%
  filter(str_detect(metabolite, "Guanine")) %>% 
  filter(str_detect(treatment, "RH|RL|LH|LL")) %>% 
  ggplot(aes(x = date, y = nmol_avg, color = factor(treatment, levels = level_order))) +
  geom_line() +
  geom_point() +
  geom_errorbar(aes(ymin = nmol_avg - sd, ymax = nmol_avg + sd)) + 
  scale_color_manual(values = c("gold", "lightcoral", "orange", "brown3"), 
                     labels = c("Lower (than Redfield) ratio of N:P, low dose added", "Lower (than Redfield) ratio of N:P, high dose added", 
                                "Redfield Ratio of N:P, low dose added", "Redfield Ratio of N:P, high dose added"), 
                     name = "Treatment") + 
  guides(fill=guide_legend(ncol=2)) + 
  theme_bw() + 
  ggtitle("Timeseries of Guanine, Summarised by Triplicate") + 
  xlab("Date") + 
  ylab("nM (nmol per L)") 
```
## Amino Acids
### Timeseries Boxplot
```{r}
aminos <- read.csv(
  "https://raw.githubusercontent.com/IngallsLabUW/Ingalls_Standards/master/Ingalls_Lab_Standards.csv",
                              stringsAsFactors = FALSE, header = TRUE) %>% 
  filter(Compound_Type == "Amino Acid") %>% 
  select(metabolite = Compound_Name, emp_form = Empirical_Formula, metabolite_name = Compound_Name_Figure)

peridice_aas <- data_vis %>% 
  filter(metabolite %in% aminos$metabolite)

peridice_aas %>% 
  group_by(metabolite, treatment, date) %>% 
  filter(str_detect(treatment, "C|RH|RL|LH|LL")) %>% 
  ggplot(aes(x = factor(date), y = nM, color = factor(treatment, levels = level_order))) +
  geom_boxplot() + 
  scale_color_manual(values = c("plum2", "gold", "lightcoral", "orange", "brown3"),
                     labels = c("Control", "6N:1P, low dose added",
                                "6N:1P, high dose added",
                                "16N:1P, low dose added", "16N:1P, high dose added"),
                     name = "Treatment") +
  guides(fill=guide_legend(ncol=2)) + 
  theme_bw() + 
  xlab("Date") + 
  ylab("nM (nmol per L)") + 
  facet_wrap(~metabolite, scales = "free_y") + 
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5))
```

### NMDS
```{r}
quant_nmds_aas <- data_vis %>% 
  # arrange(desc(nM)) %>% 
  # group_by(metabolite, replicate) %>% 
  # slice(1) %>% 
  group_by(metabolite, treatment, date) %>%
  summarise(avg_nmol = mean(nM)) %>%
  ungroup() %>%
  # complete(metabolite, date, treatment) %>%
  # mutate(avg_nmol = replace_na(avg_nmol, 0)) %>%
  mutate(id = paste(date, treatment)) %>% 
  filter(!str_detect(treatment, "Tote")) %>% 
  filter(metabolite %in% aminos$metabolite)

quant_mat_aas <- quant_nmds_aas %>%
  group_by(metabolite) %>%
  mutate(norm_conc = rank(avg_nmol)) %>%
  select(metabolite, norm_conc, id) %>% 
  pivot_wider(names_from = "metabolite", values_from = "norm_conc", values_fill = 0) %>%
  column_to_rownames("id") %>%
  data.matrix() 

mdsout_aas <- quant_mat_aas %>%
  metaMDS(k = 2, autotransform = FALSE)

mds_data <- metadataframe %>% 
  ungroup() %>% 
  mutate(timepoint = str_replace_all(timepoint, "July", "-7-22")) %>% 
  mutate(timepoint = str_replace_all(timepoint, "June", "-6-22")) %>% 
  mutate(date = as.Date(timepoint, format = "%d-%m-%y")) %>% 
  filter(str_detect(filename, "Smp")) %>% 
  mutate(treatment = str_remove(treatment, "\\d")) %>% 
  mutate(id = paste(date, treatment))


mdsout_aas$points %>%
  as.data.frame() %>%
  rownames_to_column("id") %>%
  left_join(mds_data) %>%
  mutate(date_fct = factor(date)) %>% 
  ggplot() +
  geom_point(aes(x=MDS1, y=MDS2, color=factor(treatment, levels = level_order), shape = date_fct), size=4) +
  scale_color_manual(values = c("plum2","mediumpurple3","darkslategray2", "lightseagreen","gold", "lightcoral","orange", "brown3"),
                     labels = c("Control","0N:1P:1Fe, high dose P","0N:1P, low dose added", "0N:1P, high dose added",
                                "6N:1P, low dose added", "6N:1P, high dose added",
                                "16N:1P, low dose added", "16N:1P, high dose added"),
                     name = "Treatment") +
  scale_shape_discrete(name = "Date") + 
  theme_bw() + 
  ggtitle("Amino Acid Concentration (nM) Across Treatments")
```


### Heatmap
```{r}
ranked_aas <- quant_nmds_heat %>% 
  # group_by(metabolite) %>%
  # filter(str_detect(treatment, "RH|RL|C|Tote")) %>% 
  # filter(avg_nmol >= 0.01) %>% 
  complete(metabolite, id, fill = list(avg_nmol = 0)) %>% 
  group_by(metabolite) %>% 
  mutate(norm_conc = rank(avg_nmol)) %>%
  select(metabolite, norm_conc, id) %>% 
  filter(metabolite %in% aminos$metabolite) 

ranked_aas %>% 
  ggplot() +
  geom_raster(aes(x = metabolite, y = factor(id, levels = heat_level_order_treat), fill = norm_conc)) +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) +
  scale_fill_gradient2(low = "steelblue", mid = "grey90",
                       high = "goldenrod1", midpoint = 16.5,
                       breaks=c(0, 16.5, 33), labels=c(
                         "Very little of a given compound",
                         "Median compound abundance",
                         "Compound maximum"
                       )) +
  new_scale_fill() 
  # scale_fill_discrete(guide="none") +
  # theme_void() +
  # theme(legend.position = "top",
  #       legend.key.width = unit(dev.size()[1] / 6, "inches"),
  #       legend.text = element_text(size=8))
```


## Osmolytes
### Boxplot Timeseries
```{r}
osmos <- read.csv(
  "https://raw.githubusercontent.com/IngallsLabUW/Ingalls_Standards/master/Ingalls_Lab_Standards.csv",
                              stringsAsFactors = FALSE, header = TRUE) %>% 
  filter(Compound_Type == "Osmolyte") %>% 
  select(metabolite = Compound_Name, emp_form = Empirical_Formula, metabolite_name = Compound_Name_Figure)

peridice_osmos <- data_vis %>% 
  filter(metabolite %in% osmos$metabolite) %>% 
  mutate(metab_type = "Osmolyte")

peridice_osmos %>% 
  group_by(metabolite, treatment, date) %>% 
  # filter(!str_detect(treatment, "Tote")) %>% 
  filter(str_detect(treatment, "C|RH|RL|LH|LL")) %>% 
  # filter(str_detect(metabolite, "2-O-alpha-D-Glucosylglycerol|Ectoine|Ethanolamine|Trimethylamine N-oxide")) %>% 
  ggplot(aes(x = factor(date), y = nM, color = factor(treatment, levels = level_order))) +
  geom_boxplot() + 
  scale_color_manual(values = c("plum2", "gold", "lightcoral", "darkorange", "brown3"),
                     labels = c("Control", "6N:1P, low dose added",
                                "6N:1P, high dose added",
                                "16N:1P, low dose added", "16N:1P, high dose added"),
                     name = "Treatment") +
  guides(fill=guide_legend(ncol=2)) + 
  theme_bw() + 
  xlab("Date") + 
  ylab("nM (nmol per L)") + 
  facet_wrap(~metabolite, scales = "free_y") + 
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5))
```


```{r}
quant_nmds_osmos <- data_vis %>% 
  # arrange(desc(nM)) %>% 
  # group_by(metabolite, replicate) %>% 
  # slice(1) %>% 
  group_by(metabolite, treatment, date) %>%
  summarise(avg_nmol = mean(nM)) %>%
  ungroup() %>%
  # complete(metabolite, date, treatment) %>%
  # mutate(avg_nmol = replace_na(avg_nmol, 0)) %>%
  mutate(id = paste(date, treatment)) %>% 
  filter(!str_detect(treatment, "Tote")) %>% 
  filter(metabolite %in% osmos$metabolite)

quant_mat_osmos <- quant_nmds_osmos %>%
  group_by(metabolite) %>%
  mutate(norm_conc = rank(avg_nmol)) %>%
  select(metabolite, norm_conc, id) %>% 
  pivot_wider(names_from = "metabolite", values_from = "norm_conc", values_fill = 0) %>%
  column_to_rownames("id") %>%
  data.matrix() 

mdsout_osmos <- quant_mat_osmos %>%
  metaMDS(k = 2, autotransform = FALSE)

mds_data <- metadataframe %>% 
  ungroup() %>% 
  mutate(timepoint = str_replace_all(timepoint, "July", "-7-22")) %>% 
  mutate(timepoint = str_replace_all(timepoint, "June", "-6-22")) %>% 
  mutate(date = as.Date(timepoint, format = "%d-%m-%y")) %>% 
  filter(str_detect(filename, "Smp")) %>% 
  mutate(treatment = str_remove(treatment, "\\d")) %>% 
  mutate(id = paste(date, treatment))


mdsout_osmos$points %>%
  as.data.frame() %>%
  rownames_to_column("id") %>%
  left_join(mds_data) %>%
  mutate(date_fct = factor(date)) %>% 
  ggplot() +
  geom_point(aes(x=MDS1, y=MDS2, color=factor(treatment, levels = level_order), shape = date_fct), size=4) +
  scale_color_manual(values = c("plum2","mediumpurple3","darkslategray2", "lightseagreen","gold", "lightcoral","orange", "brown3"),
                     labels = c("Control","0N:1P:1Fe, high dose P","0N:1P, low dose added", "0N:1P, high dose added",
                                "6N:1P, low dose added", "6N:1P, high dose added",
                                "16N:1P, low dose added", "16N:1P, high dose added"),
                     name = "Treatment") +
  scale_shape_discrete(name = "Date") + 
  theme_bw() + 
  ggtitle("Osmolyte Concentration (nM) Across Treatments")
```


### Heatmap
```{r}
ranked_osmos <- quant_nmds_heat %>% 
  # group_by(metabolite) %>%
  # filter(str_detect(treatment, "RH|RL|C|Tote")) %>% 
  # filter(avg_nmol >= 0.01) %>% 
  complete(metabolite, id, fill = list(avg_nmol = 0)) %>% 
  group_by(metabolite) %>% 
  mutate(norm_conc = rank(avg_nmol)) %>%
  select(metabolite, norm_conc, id) %>% 
  filter(metabolite %in% osmos$metabolite) 

ranked_osmos %>% 
  ggplot() +
  geom_raster(aes(x = metabolite, y = factor(id, levels = heat_level_order_treat), fill = norm_conc)) +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) +
  scale_fill_gradient2(low = "steelblue", mid = "grey90",
                       high = "goldenrod1", midpoint = 16.5,
                       breaks=c(0, 16.5, 33), labels=c(
                         "Very little of a given compound",
                         "Median compound abundance",
                         "Compound maximum"
                       )) +
  new_scale_fill()
```

## Nucleic Acids
### Boxplot Timeseries
```{r}
nucleos <- read.csv(
  "https://raw.githubusercontent.com/IngallsLabUW/Ingalls_Standards/master/Ingalls_Lab_Standards.csv",
                              stringsAsFactors = FALSE, header = TRUE) %>% 
  filter(Compound_Type == "Nucleic Acid") %>% 
  select(metabolite = Compound_Name, emp_form = Empirical_Formula, metabolite_name = Compound_Name_Figure)

peridice_nucleos <- data_vis %>% 
  filter(metabolite %in% nucleos$metabolite) %>% 
  mutate(metab_type = "Nucleic Acid")

peridice_nucleos %>% 
  group_by(metabolite, treatment, date) %>% 
  filter(str_detect(treatment, "C|RH|RL|LH|LL")) %>% 
  ggplot(aes(x = factor(date), y = nM, color = factor(treatment, levels = level_order))) +
  geom_boxplot() + 
  scale_color_manual(values = c("plum2", "gold", "lightcoral", "orange", "brown3"),
                     labels = c("Control", "6N:1P, low dose added",
                                "6N:1P, high dose added",
                                "16N:1P, low dose added", "16N:1P, high dose added"),
                     name = "Treatment") +
  guides(fill=guide_legend(ncol=2)) + 
  theme_bw() + 
  xlab("Date") + 
  ylab("nM (nmol per L)") + 
  facet_wrap(~metabolite, scales = "free_y") + 
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5))
```

```{r}
quant_nmds_nucleos <- data_vis %>% 
  # arrange(desc(nM)) %>% 
  # group_by(metabolite, replicate) %>% 
  # slice(1) %>% 
  group_by(metabolite, treatment, date) %>%
  summarise(avg_nmol = mean(nM)) %>%
  ungroup() %>%
  # complete(metabolite, date, treatment) %>%
  # mutate(avg_nmol = replace_na(avg_nmol, 0)) %>%
  mutate(id = paste(date, treatment)) %>% 
  filter(!str_detect(treatment, "Tote")) %>% 
  filter(metabolite %in% nucleos$metabolite)

quant_mat_nucleos <- quant_nmds_nucleos %>%
  group_by(metabolite) %>%
  mutate(norm_conc = rank(avg_nmol)) %>%
  select(metabolite, norm_conc, id) %>% 
  pivot_wider(names_from = "metabolite", values_from = "norm_conc", values_fill = 0) %>%
  column_to_rownames("id") %>%
  data.matrix() 

mdsout_nucleos <- quant_mat_nucleos %>%
  metaMDS(k = 2, autotransform = FALSE)

mds_data <- metadataframe %>% 
  ungroup() %>% 
  mutate(timepoint = str_replace_all(timepoint, "July", "-7-22")) %>% 
  mutate(timepoint = str_replace_all(timepoint, "June", "-6-22")) %>% 
  mutate(date = as.Date(timepoint, format = "%d-%m-%y")) %>% 
  filter(str_detect(filename, "Smp")) %>% 
  mutate(treatment = str_remove(treatment, "\\d")) %>% 
  mutate(id = paste(date, treatment))


mdsout_nucleos$points %>%
  as.data.frame() %>%
  rownames_to_column("id") %>%
  left_join(mds_data) %>%
  mutate(date_fct = factor(date)) %>% 
  ggplot() +
  geom_point(aes(x=MDS1, y=MDS2, color=factor(treatment, levels = level_order), shape = date_fct), size=4) +
  scale_color_manual(values = c("plum2","mediumpurple3","darkslategray2", "lightseagreen","gold", "lightcoral","orange", "brown3"),
                     labels = c("Control","0N:1P:1Fe, high dose P","0N:1P, low dose added", "0N:1P, high dose added",
                                "6N:1P, low dose added", "6N:1P, high dose added",
                                "16N:1P, low dose added", "16N:1P, high dose added"),
                     name = "Treatment") +
  scale_shape_discrete(name = "Date") + 
  theme_bw() + 
  ggtitle("Nucleic Acid Concentration (nM) Across Treatments")
```


### Heatmap
```{r}
ranked_nucleos <- quant_nmds_heat %>% 
  # group_by(metabolite) %>%
  # filter(str_detect(treatment, "RH|RL|C|Tote")) %>% 
  # filter(avg_nmol >= 0.01) %>% 
  complete(metabolite, id, fill = list(avg_nmol = 0)) %>% 
  group_by(metabolite) %>% 
  mutate(norm_conc = rank(avg_nmol)) %>%
  select(metabolite, norm_conc, id) %>% 
  filter(metabolite %in% nucleos$metabolite) 

ranked_nucleos %>% 
  ggplot() +
  geom_raster(aes(x = metabolite, y = factor(id, levels = heat_level_order_treat), fill = norm_conc)) +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) +
  scale_fill_gradient2(low = "steelblue", mid = "grey90",
                       high = "goldenrod1", midpoint = 16.5,
                       breaks=c(0, 16.5, 33), labels=c(
                         "Very little of a given compound",
                         "Median compound abundance",
                         "Compound maximum"
                       )) +
  new_scale_fill() 
```


## Sulfur-Containing Metabolites
### Boxplot Timeseries
```{r}
sulfur <- read.csv(
  "https://raw.githubusercontent.com/IngallsLabUW/Ingalls_Standards/master/Ingalls_Lab_Standards.csv",
                              stringsAsFactors = FALSE, header = TRUE) %>% 
  filter(Compound_Type == "Sulfur") %>% 
  select(metabolite = Compound_Name, emp_form = Empirical_Formula, metabolite_name = Compound_Name_Figure)

peridice_sulf <- data_vis %>% 
  filter(metabolite %in% sulfur$metabolite) %>% 
  filter(metabolite != "2-Hydroxy-4-(methylthio)butyric acid") %>% 
  filter(metabolite != "L-Cysteinesulfinic acid") %>% 
  filter(metabolite != "Sodium taurocholate") %>% 
  filter(metabolite != "Amino hydroxypropanesulfonate") %>% 
  filter(metabolite != "3-Aminopropanesulfonate") %>% 
  filter(metabolite != "3-Sulfopyruvic acid") %>% 
  filter(metabolite != "2-keto-4-methylthiobutyric acid") %>% 
  mutate(metab_type = "Sulfur-Containing")

peridice_sulf %>% 
  group_by(metabolite, treatment, date) %>% 
  # filter(!str_detect(treatment, "Tote")) %>% 
  filter(str_detect(treatment, "C|RH|RL|LH|LL")) %>% 
  ggplot(aes(x = factor(date), y = nM, color = factor(treatment, levels = level_order))) +
  geom_boxplot() + 
  scale_color_manual(values = c("plum2", "gold", "lightcoral", "orange", "brown3"),
                     labels = c("Control", "6N:1P, low dose added",
                                "6N:1P, high dose added",
                                "16N:1P, low dose added", "16N:1P, high dose added"),
                     name = "Treatment") +
  guides(fill=guide_legend(ncol=2)) + 
  theme_bw() + 
  xlab("Date") + 
  ylab("nM (nmol per L)") + 
  facet_wrap(~metabolite, scales = "free_y") + 
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) + 
  ggtitle("Concentrations of Sulfur-Containing Compounds")
```

```{r}
quant_nmds_sulf <- data_vis %>% 
  # arrange(desc(nM)) %>% 
  # group_by(metabolite, replicate) %>% 
  # slice(1) %>% 
  group_by(metabolite, treatment, date) %>%
  summarise(avg_nmol = mean(nM)) %>%
  ungroup() %>%
  # complete(metabolite, date, treatment) %>%
  # mutate(avg_nmol = replace_na(avg_nmol, 0)) %>%
  mutate(id = paste(date, treatment)) %>% 
  filter(!str_detect(treatment, "Tote")) %>% 
  filter(metabolite %in% sulfur$metabolite)

quant_mat_sulf <- quant_nmds_sulf %>%
  group_by(metabolite) %>%
  mutate(norm_conc = rank(avg_nmol)) %>%
  select(metabolite, norm_conc, id) %>% 
  pivot_wider(names_from = "metabolite", values_from = "norm_conc", values_fill = 0) %>%
  column_to_rownames("id") %>%
  data.matrix() 

mdsout_sulf <- quant_mat_sulf %>%
  metaMDS(k = 2, autotransform = FALSE)

mds_data <- metadataframe %>% 
  ungroup() %>% 
  mutate(timepoint = str_replace_all(timepoint, "July", "-7-22")) %>% 
  mutate(timepoint = str_replace_all(timepoint, "June", "-6-22")) %>% 
  mutate(date = as.Date(timepoint, format = "%d-%m-%y")) %>% 
  filter(str_detect(filename, "Smp")) %>% 
  mutate(treatment = str_remove(treatment, "\\d")) %>% 
  mutate(id = paste(date, treatment))


mdsout_sulf$points %>%
  as.data.frame() %>%
  rownames_to_column("id") %>%
  left_join(mds_data) %>%
  mutate(date_fct = factor(date)) %>% 
  ggplot() +
  geom_point(aes(x=MDS1, y=MDS2, color=factor(treatment, levels = level_order), shape = date_fct), size=4) +
  scale_color_manual(values = c("plum2","mediumpurple3","darkslategray2", "lightseagreen","gold", "lightcoral","orange", "brown3"),
                     labels = c("Control","0N:1P:1Fe, high dose P","0N:1P, low dose added", "0N:1P, high dose added",
                                "6N:1P, low dose added", "6N:1P, high dose added",
                                "16N:1P, low dose added", "16N:1P, high dose added"),
                     name = "Treatment") +
  scale_shape_discrete(name = "Date") + 
  theme_bw() + 
  ggtitle("Variation of Metabolite Concentration (nM) Across Treatments")
```


### Heatmap 
```{r}
ranked_sulf <- quant_nmds_heat %>% 
  # group_by(metabolite) %>%
  # filter(str_detect(treatment, "RH|RL|C|Tote")) %>% 
  # filter(avg_nmol >= 0.01) %>% 
  complete(metabolite, id, fill = list(avg_nmol = 0)) %>% 
  group_by(metabolite) %>% 
  mutate(norm_conc = rank(avg_nmol)) %>%
  select(metabolite, norm_conc, id) %>% 
  filter(metabolite %in% sulfur$metabolite) 

ranked_sulf %>% 
  ggplot() +
  geom_raster(aes(x = metabolite, y = factor(id, levels = heat_level_order_treat), fill = norm_conc)) +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) +
  scale_fill_gradient2(low = "steelblue", mid = "grey90",
                       high = "goldenrod1", midpoint = 16.5,
                       breaks=c(0, 16.5, 33), labels=c(
                         "Very little of a given compound",
                         "Median compound abundance",
                         "Compound maximum"
                       )) +
  new_scale_fill() 
```

```{r}

```


# Metabolite Function Distribution 
## AA, Osmos, Nucleic acids, Sulfur
```{r}
peridice_metab_groups <- peridice_aas %>% 
  mutate(metab_type = "Amino Acid") %>% 
  rbind(peridice_nucleos, peridice_sulf, peridice_osmos) 

peridice_metab_groups %>% 
  mutate(nmol_rank=(nM-min(nM))/(max(nM)-min(nM))) %>%
  group_by(metab_type, treatment, date) %>% 
  mutate(avg_nmol = mean(nmol_rank)) %>% 
  distinct(avg_nmol, .keep_all = TRUE) %>% 
  filter(str_detect(treatment, "RH|RL|LH|LL|C")) %>% 
  ggplot() + 
  geom_col(aes(x = date, y = avg_nmol, fill = metab_type), position = "stack") + 
  scale_fill_manual(values = c("palegreen4", "palegreen3", "goldenrod1", "darkgoldenrod3"), name = "Metabolite Type") + 
  facet_grid(~metab_type~factor(treatment, levels = level_order), scales = "free_y") + 
  theme_bw() + 
  xlab("Treatment Group")
```

## Entire Stds Sheet Metab Function Groups
```{r}
nb.cols <- 11
mycolors <- colorRampPalette(brewer.pal(8, "Paired"))(nb.cols)

metab_groups <- read.csv(
  "https://raw.githubusercontent.com/IngallsLabUW/Ingalls_Standards/master/Ingalls_Lab_Standards.csv",
                              stringsAsFactors = FALSE, header = TRUE) %>% 
  select(metabolite = Compound_Name, emp_form = Empirical_Formula, metab_type = Compound_Type)

data_vis_groups <- data_vis %>% 
  left_join(metab_groups, by = "metabolite") %>% 
  # mutate(metab_type = str_replace_all(metab_type, " - degraded", "")) %>% 
  # mutate(metab_type = str_replace_all(metab_type, " derivative", "")) %>% 
  # mutate(metab_type = str_replace_all(metab_type, " synthesis", "")) %>% 
  mutate(metab_type = str_replace_all(metab_type, " - collagen", "")) %>% 
  filter(!str_detect(metab_type, "Cursed|Amino sugar|Alkaloid|Energy charge|Amine|Environmental contaminant|Organic Acid|Arsenic|Tripeptide|Peptidoglycan|Lignin|Vitamin|Antioxidant|Dipeptide|Calvin|Nucleotide|Intra|Redox|Quorum")) %>% 
  mutate(metab_type = str_replace_all(metab_type, " - nitrogenous", "")) %>% 
  mutate(metab_type = str_replace_all(metab_type, " alchohol", "")) %>% 
  mutate(metab_type = str_replace_all(metab_type, " phosphate", "")) %>% 
  mutate(metab_type = str_replace_all(metab_type, "Glycine metabolite", "Amino Acid")) %>% 
  mutate(metab_type = str_replace_all(metab_type, "Betaine", "Amino Acid")) %>% 
  mutate(metab_type = str_replace_all(metab_type, "Purine|Pyrimidine", "Nucleoside"))
  
data_vis_groups %>% 
  group_by(metabolite, treatment, date) %>% 
  mutate(nmol_avg = mean(nM)) %>% 
  distinct(metab_type, .keep_all = TRUE) %>% 
  # filter(str_detect(treatment, "LL|LH|RL|RH")) %>% 
  filter(!str_detect(treatment, "Tote")) %>% 
  # filter(str_detect(replicate, "14July|27July")) %>% 
  ggplot() +
  geom_col(aes(x = factor(date), y = nmol_avg, fill = metab_type), position = "fill") +
  scale_fill_manual(values = mycolors, name = "Metabolite Type") + 
  facet_grid(~treatment, scales = "free_y") + 
  theme_bw() + 
  ylab("Metabolite Composition (nM)") + 
  xlab("Date")
```

## Split by ratio/rate
```{r}
data_vis_rat_taxon <- data_vis_groups %>% 
  mutate(rate = str_extract(treatment, "H$|F$|C$|L$|Tote$")) %>% 
  mutate(ratio = str_extract(treatment, "R|L|Z|C")) 
```

### Plots
```{r}
data_vis_rat_taxon %>% 
  group_by(date, treatment, metab_type) %>% 
  mutate(avg_nmol = mean(nM)) %>% 
  mutate(ratio = str_replace(ratio, "L", "6N:1P")) %>% 
  mutate(ratio = str_replace(ratio, "R", "16N:1P")) %>% 
  mutate(ratio = str_replace(ratio, "Z", "0N:1P")) %>% 
  mutate(ratio = str_replace(ratio, "C", "Control")) %>% 
  mutate(rate = str_replace(rate, "H", "High Dose")) %>% 
  mutate(rate = str_replace(rate, "L", "Low Dose")) %>% 
  mutate(rate = str_replace(rate, "C", "Control")) %>% 
  mutate(rate = str_replace(rate, "F", "High Dose")) %>% 
  filter(!str_detect(treatment, "C")) %>% 
  distinct(avg_nmol, .keep_all = TRUE) %>% 
  na.omit() %>% 
  ggplot() + 
  geom_col(aes(x = factor(date), y = avg_nmol, fill = metab_type), position = "fill") + 
  scale_fill_manual(values = mycolors, name = "Metabolite Function") +
  facet_grid(~rate~ratio) + 
  theme_bw() + 
  ggtitle("Ratio of Nutrients Impacts on Metabolite Composition")+
  ylab("Average Metabolite Concentrations (nM)") + 
  xlab("Date") + 
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5))
```

### T0 to 6/30

# Generalized Linear Models for testing hypotheses:
Hypotheses: Week 4 groups of metabolites: X metabs increase in Y treatments/ratios. Prove with linear model
Cluster 2: no nitrogen added - metabolites respond to changes in phosphate addition (ratio not rate). Which metabs? Associated with anything?
Cluster 4: Redfield ratio - metabolites respond to redfield ratio (not rate). Which metabs? Associated with anything?
Cluster 6: High dose - metabolites respond to high dose of nutrients (need N). Which metabs? Associated with anything?


NMDS with amino acids/ clusters from heatmap or k means clusters

peak areas over time ran on machine - pull out time from google drive

# Filter by Peak Quality
```{r}
metab_qual <- read_csv("csvs/peak_quality.csv") %>% 
  select(metabolite = Metabolite, quality = Quality)

data_vis_qual <- data_vis %>% 
  left_join(metab_qual) %>% 
  filter(quality == "Good")
```

```{r}
quant_nmds_good <- data_vis_qual %>% 
  group_by(metabolite, treatment, date, replicate) %>%
  summarise(avg_nmol = mean(nM)) %>%
  ungroup() %>%
  mutate(replicate = str_remove(replicate, "230616_")) %>% 
  mutate(id = replicate) %>% 
  filter(!str_detect(treatment, "Tote"))

quant_mat_good <- quant_nmds_good %>%
  group_by(metabolite) %>%
  mutate(norm_conc = rank(avg_nmol)) %>%
  select(metabolite, norm_conc, id) %>% 
  pivot_wider(names_from = "metabolite", values_from = "norm_conc", values_fill = 0) %>%
  column_to_rownames("id") %>%
  data.matrix() 

mdsout_good <- quant_mat_good %>%
  metaMDS(k = 2, autotransform = FALSE)

mds_data <- metadataframe %>% 
  ungroup() %>% 
  mutate(timepoint = str_replace_all(timepoint, "July", "-7-22")) %>% 
  mutate(timepoint = str_replace_all(timepoint, "June", "-6-22")) %>% 
  mutate(date = as.Date(timepoint, format = "%d-%m-%y")) %>% 
  filter(str_detect(filename, "Smp")) %>% 
  mutate(treatment = str_remove(treatment, "\\d")) %>% 
  mutate(id = paste(filename))


mdsout_good$points %>%
  as.data.frame() %>%
  rownames_to_column("id") %>%
  left_join(mds_data) %>%
  mutate(date_fct = factor(date)) %>% 
  ggplot() +
  geom_point(aes(x=MDS1, y=MDS2, color=factor(treatment, level = level_order), shape = date_fct), size=4) +
  scale_color_manual(values = c("plum2","mediumpurple3","darkslategray2", "lightseagreen","gold", "lightcoral","orange", "brown3"),
                     labels = c("Control","0N:1P, low dose Fe","0N:1P, low dose added", "0N:1P, high dose added",
                                "6N:1P, low dose added", "6N:1P, high dose added",
                                "16N:1P, low dose added", "16N:1P, high dose added"),
                     name = "Treatment") +
  scale_shape_discrete(name = "Date") + 
  theme_bw() + 
  ggtitle("Variation of Metabolite Concentration (nM) Across Treatments")
```


```{r}
quant_nmds_good <- data_vis_qual %>% 
  # arrange(desc(nM)) %>% 
  # group_by(metabolite, replicate) %>% 
  # slice(1) %>% 
  group_by(metabolite, treatment, date) %>%
  summarise(avg_nmol = mean(nM)) %>%
  ungroup() %>%
  # complete(metabolite, date, treatment) %>%
  # mutate(avg_nmol = replace_na(avg_nmol, 0)) %>%
  mutate(id = paste(date, treatment)) %>% 
  filter(!str_detect(treatment, "Tote"))

quant_mat_good <- quant_nmds_good %>%
  group_by(metabolite) %>%
  # mutate(cn_rank=(cn-min(cn))/(max(cn)-min(cn)))
  mutate(norm_conc = (avg_nmol - min(avg_nmol)) / (max(avg_nmol) - min(avg_nmol))) %>%
  filter(norm_conc != "NaN") %>%  
  select(metabolite, norm_conc, id) %>% 
  pivot_wider(names_from = "metabolite", values_from = "norm_conc", values_fill = 0) %>%
  column_to_rownames("id") %>%
  data.matrix() 

mdsout_good <- quant_mat_good %>%
  metaMDS(k = 2, autotransform = FALSE)

mds_data <- metadataframe %>% 
  ungroup() %>% 
  mutate(timepoint = str_replace_all(timepoint, "July", "-7-22")) %>% 
  mutate(timepoint = str_replace_all(timepoint, "June", "-6-22")) %>% 
  mutate(date = as.Date(timepoint, format = "%d-%m-%y")) %>% 
  filter(str_detect(filename, "Smp")) %>% 
  mutate(treatment = str_remove(treatment, "\\d")) %>% 
  mutate(id = paste(date, treatment))


mdsout_good$points %>%
  as.data.frame() %>%
  rownames_to_column("id") %>%
  left_join(mds_data) %>%
  mutate(date_fct = factor(date)) %>% 
  ggplot() +
  geom_point(aes(x=MDS1, y=MDS2, color=factor(treatment, levels = level_order), shape = date_fct), size=4) +
  scale_color_manual(values = c("plum2","mediumpurple3","darkslategray2", "lightseagreen","gold", "lightcoral","orange", "brown3"),
                     labels = c("Control","0N:1P:0Fe, high dose P","0N:1P, low dose added", "0N:1P, high dose added",
                                "6N:1P, low dose added", "6N:1P, high dose added",
                                "16N:1P, low dose added", "16N:1P, high dose added"),
                     name = "Treatment") +
  scale_shape_discrete(name = "Date") + 
  theme_bw() + 
  ggtitle("Metabolite Variance Across Nutrient Ratios")
```
```{r}
quant_nmds_heat_good <- data_vis_qual %>% 
  group_by(metabolite, treatment, date) %>%
  summarise(avg_nmol = mean(nM)) %>% 
  ungroup() %>%
  mutate(id = paste(date, treatment)) 
# %>% 
#   filter(str_detect(treatment, "RH|RL|LH|LL"))

heatmap_data_good <- quant_nmds_heat_good %>% 
  # group_by(metabolite) %>%
  # filter(str_detect(treatment, "RH|RL|C|Tote")) %>% 
  # filter(avg_nmol >= 0.01) %>% 
  complete(metabolite, id, fill = list(avg_nmol = 0)) %>% 
  group_by(metabolite) %>% 
  # mutate(norm_conc = rank(avg_nmol)) %>%
  mutate(norm_conc = (avg_nmol - min(avg_nmol)) / (max(avg_nmol) - min(avg_nmol))) %>% 
  filter(norm_conc != "NaN") %>%  
  select(metabolite, norm_conc, id) %>%
  pivot_wider(names_from = "metabolite", values_from = "norm_conc") %>%
  # mutate(id=factor(id, levels=c(heat_level_order_treat))) %>%
  arrange(id) %>%
  na.omit() %>% 
  column_to_rownames("id")

heatmap_data_good %>%
  data.matrix() %>% 
  # heatmaply(fontsize_row = 10, fontsize_col = 7) 
  heatmaply(Rowv = FALSE, fontsize_row = 10, fontsize_col = 7)

# make clustered heatmap from scratch using pheatmap
```


```{r}
quant_nmds_heat_good <- data_vis_qual %>% 
  group_by(metabolite, treatment, date) %>%
  summarise(avg_nmol = mean(nM)) %>%
  ungroup() %>%
  mutate(id = paste(date, treatment)) 
# %>% 
#   filter(str_detect(treatment, "RH|RL|LH|LL"))

heatmap_data_good <- quant_nmds_heat_good %>% 
  # group_by(metabolite) %>%
  # filter(str_detect(treatment, "RH|RL|C|Tote")) %>% 
  # filter(avg_nmol >= 0.01) %>% 
  complete(metabolite, id, fill = list(avg_nmol = 0)) %>% 
  group_by(metabolite) %>% 
  mutate(norm_conc = rank(avg_nmol)) %>%
  # mutate(norm_conc = (avg_nmol - min(avg_nmol)) / (max(avg_nmol) - min(avg_nmol))) %>% 
  # filter(norm_conc != "NaN") %>% 
  select(metabolite, norm_conc, id) %>%
  pivot_wider(names_from = "metabolite", values_from = "norm_conc") %>%
  mutate(id=factor(id, levels=c(heat_level_order_treat))) %>%
  arrange(id) %>%
  na.omit() %>% 
  column_to_rownames("id")


plotheatmap_good <- heatmap_data_good %>%
  data.matrix() %>% 
  heatmaply(fontsize_row = 10, fontsize_col = 7) # %>%
  # heatmaply(Rowv = FALSE, fontsize_row = 10, fontsize_col = 7)

# make clustered heatmap from scratch using pheatmap

plotheatmap_good
```


# PCA
```{r}
peri_pca_long <- data_vis_qual %>% 
  pivot_wider(names_from = metabolite, values_from = nM) %>% 
  select(-c("treatment", "date", "triplicate", "quality", "replicate")) %>% 
  # column_to_rownames("replicate") %>% 
  data.matrix() %>%
  `[<-`(is.na(.), 0) %>%
  PCA(ncp = 6)

peri_pca <- data_vis_qual %>% 
  pivot_wider(names_from = metabolite, values_from = nM) %>% 
  select(-c("treatment", "date", "triplicate", "quality", "replicate")) %>% 
  # column_to_rownames("replicate") %>% 
  data.matrix() %>%
  `[<-`(is.na(.), 0) %>% 
  prcomp(center = TRUE, scale. = TRUE) 

biplot(peri_pca)

data_vis_qual <- data_vis_qual %>% 
  filter(!str_detect(metabolite, "Amino hydroxypropanesulfonate"))
```

```{r}
rate_ratio <- data_vis_qual %>% 
  mutate(ratio = str_extract(treatment, "R|L|Z|C|Tote")) %>% 
  mutate(rate = str_extract(treatment,  "H$|L$|C|F|Tote")) %>% 
  mutate(rate = str_replace(rate, "F", "H")) %>% 
  mutate(replicate = str_remove(replicate, "230616_Smp_"))

pca_mat <- rate_ratio %>% 
  select(metabolite, replicate, nM) %>% 
  group_by(metabolite) %>% 
  mutate(nM = rank(nM)) %>% 
  pivot_wider(names_from = "metabolite", values_from = "nM") %>% 
  column_to_rownames("replicate") %>% 
  data.matrix() %>% 
  `[<-`(is.na(.), 0)

prcomp(pca_mat) %>%
  pluck("x") %>%
  as.data.frame() %>%
  select(PC1:PC3) %>%
  rownames_to_column("replicate") %>%
  pivot_longer(starts_with("PC"), names_to = "PC", values_to = "PC_val") %>%
  left_join(rate_ratio) %>%
  # plotly::plot_ly(x=~PC1, y=~PC2, z=~PC3, color=~depth)
  ggplot() +
  # geom_point(aes(x=PC1, y=PC2, color=depth))
  # geom_col(aes(x=filename, y=PC1, fill=depth))
  geom_col(aes(x=replicate, y=PC_val, fill=ratio)) +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) + 
  facet_wrap(~PC, ncol=1)
```



# Foldchange
```{r}
mutate(date_fct = factor(date)) %>% 
  ggplot() +
  geom_point(aes(x=MDS1, y=MDS2, color=factor(treatment, levels = level_order), shape = date_fct), size=4)

data_vis_cluster %>% 
  filter(cluster == 1) %>% 
  # filter(metabolite %in% sulfur$metabolite) %>% 
  group_by(metabolite, date, treatment) %>%
  mutate(date_fct = factor(date)) %>% 
  mutate(avg_nmol = mean(nM)) %>% 
  ggplot(aes(x = date, y = avg_nmol, color = metabolite)) + 
  geom_line() + 
  geom_point() + 
  theme_bw() + 
  facet_wrap(~treatment)
```



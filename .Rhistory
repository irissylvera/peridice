rename(conc_um = Concentration_uM) %>%
mutate(internal_standard = str_remove(internal_standard, ", .*")) %>%
mutate(internal_standard = str_remove(internal_standard, "D"))
is_areas_inj_vol <- is_stds_data %>%
filter(str_detect(replicate, "Poo")) %>%
mutate(inj_vol = ifelse(str_detect(replicate, "Half"), 0.5, 1)) %>%
# filter(!str_detect(metabolite, "Inj_vol")) %>%
select(-c(metabolite, a, RunType, c, d)) %>%
group_by(replicate) %>%
rename(internal_standard = metabolite) %>%
group_by(internal_standard) %>%
filter(internal_standard != "Inj_vol")
isologs <- data_no_is %>%
select(replicate, metabolite, area_with_qc) %>%
left_join(is_areas_smp, by = c("replicate")) %>%
mutate(internal_standard = str_remove(internal_standard, ", .*")) %>%
mutate(internal_standard = str_remove(internal_standard, "D")) %>%
filter(metabolite %in% internal_standard) %>%
mutate(replicate = str_remove(replicate, "230616_"))
# distinct(metabolite, .keep_all = TRUE)
isologs_quant <- isologs %>%
left_join(is_conc, by = c("internal_standard")) %>%
left_join(metadata_targ, by = c("replicate")) %>%
filter(metabolite == internal_standard) %>%
#  mutate(area_with_qc = area_with_qc / pc_um) %>%
mutate(umol_per_vial = (area_with_qc/int_area)*conc_um) %>%
mutate(umol_enviro = umol_per_vial*400*1e-6/vol_L_filt*1000) %>%
select(replicate, metabolite, treatment, area_with_qc, date, umol_enviro) %>%
mutate(nmol_enviro = umol_enviro*1000)
colors <- c("C" = "plum2", "LH" = "lightcoral", "LL" = "gold", "RH" = "brown3", "RL" = "orange", "T0" = "grey50",
"ZF" = "mediumpurple", "ZH" = "lightseagreen", "ZL" = "darkslategray2")
isologs_quant %>%
filter(metabolite == "Trimethylamine N-oxide") %>%
group_by(treatment, date, metabolite) %>%
mutate(avg_umol_enviro = mean(umol_enviro)) %>%
distinct(avg_umol_enviro, .keep_all = TRUE) %>%
ggplot() +
geom_line(aes(x = date, y = avg_umol_enviro, color = treatment)) +
scale_color_manual(values = colors) +
theme_bw()
isologs_quant %>%
filter(metabolite == "Trimethylamine N-oxide") %>%
group_by(treatment, date, metabolite) %>%
mutate(avg_umol_enviro = mean(umol_enviro)) %>%
distinct(avg_umol_enviro, .keep_all = TRUE) %>%
ggplot() +
geom_line(aes(x = date, y = avg_umol_enviro, color = treatment)) +
scale_color_manual(values = colors) +
theme_bw()
rsd_data <- data_long %>%
mutate(rsd_og = sd(poo_area)/mean(poo_area)) %>%
left_join(is_areas, by = c("replicate")) %>%
filter(!metabolite %in% isologs$metabolite) %>%
mutate(norm_area = poo_area/int_area*avg_is_area) %>%
group_by(metabolite, internal_standard) %>%
mutate(rsd = sd(norm_area)/mean(norm_area)) %>%
group_by(metabolite, internal_standard) %>%
mutate(rsd_imp = (rsd_og - rsd)/rsd_og)
poo_bmis <- rsd_data %>%
filter(rsd_imp > .4) %>%
arrange(desc(rsd_imp)) %>%
group_by(metabolite) %>%
slice(1) %>%
select(metabolite, internal_standard, rsd, int_area, avg_is_area) %>%
rename(bmis = internal_standard) %>%
rename(rsd_poo = rsd)
sample_long <- data_no_is %>%
select(replicate, metabolite, num_area) %>%
filter(!str_detect(replicate, "Poo|Std")) %>%
filter(!metabolite %in% isologs$metabolite) %>%
left_join(poo_bmis) %>%
na.omit() %>%
mutate(norm_area = num_area/int_area*avg_is_area) %>%
group_by(metabolite, bmis) %>%
mutate(rsd = sd(norm_area)/mean(norm_area))
sample_long %>%
ggplot() +
geom_point(aes(x = rsd_poo, y = rsd)) +
facet_wrap(~bmis)
ingalls_stds_quant <- read_csv("https://raw.githubusercontent.com/IngallsLabUW/Ingalls_Standards/master/Ingalls_Lab_Standards.csv") %>%
select(metabolite_name = Compound_Name_Figure, metabolite = Compound_Name, conc_um = Concentration_uM,
empirical_formula = Empirical_Formula, z, ion_form = Ionization_Form, mix = HILIC_Mix) %>%
# filter(z == 1) %>%
na.omit()
filt_data_quant <- filt_data %>%
select(filename, vol_L_filt) %>%
rename(replicate = filename) %>%
mutate(replicate = str_remove(replicate, ".mzML"))
adj_bmis_data <- sample_long %>%
mutate(adj_peak_area = num_area/(int_area/avg_is_area)) %>%
full_join(peak_list) %>%
select(replicate, metabolite, bmis, adj_peak_area) %>%
mutate(replicate = str_remove(replicate, "230616_"))
rfs_mix1 <- peak_list %>%
mutate(replicate = str_remove(replicate, "230213_")) %>%
filter(str_detect(replicate, "Std")) %>%
select(replicate, metabolite, num_area) %>%
left_join(ingalls_stds_quant, by = c("metabolite")) %>%
na.omit() %>%
mutate(std_type = str_extract(replicate, "InH2O|InMatrix|H2OinMatrix_1|H2OinMatrix_2")) %>%
group_by(metabolite, std_type) %>%
filter(mix == "Mix1") %>%
# filter(std_type == "H2OinMatrix_1") %>%
filter(!str_detect(replicate, "Mix2")) %>%
filter(!str_detect(std_type, "H2OinMatrix_2")) %>%
# need to calculate RFs based on mix
reframe(mean_area = mean(num_area, na.rm = TRUE), conc_um = unique(conc_um)) %>%
pivot_wider(names_from = std_type, values_from = mean_area) %>%
mutate(rf_h2o = InH2O/conc_um) %>%
mutate(rf_mat = (InMatrix - H2OinMatrix_1)/conc_um) %>%
mutate(rf_ratio = rf_mat / rf_h2o) %>%
na.omit() %>%
rename(H2OinMatrix = H2OinMatrix_1)
rfs_mix2 <- peak_list %>%
mutate(replicate = str_remove(replicate, "230213_")) %>%
filter(str_detect(replicate, "Std")) %>%
select(replicate, metabolite, num_area) %>%
left_join(ingalls_stds_quant, by = c("metabolite")) %>%
na.omit() %>%
mutate(std_type = str_extract(replicate, "InH2O|InMatrix|H2OinMatrix_1|H2OinMatrix_2")) %>%
group_by(metabolite, std_type) %>%
filter(mix == "Mix2") %>%
filter(!str_detect(replicate, "Mix1")) %>%
filter(!str_detect(std_type, "H2OinMatrix_1")) %>%
# need to calculate RFs based on mix
reframe(mean_area = mean(num_area, na.rm = TRUE), conc_um = unique(conc_um)) %>%
pivot_wider(names_from = std_type, values_from = mean_area) %>%
mutate(rf_h2o = InH2O/conc_um) %>%
mutate(rf_mat = (InMatrix - H2OinMatrix_2)/conc_um) %>%
mutate(rf_ratio = rf_mat / rf_h2o) %>%
na.omit() %>%
rename(H2OinMatrix = H2OinMatrix_2)
rfs <- rfs_mix1 %>%
rbind(rfs_mix2)
quant_data <- peak_list %>%
mutate(replicate = str_remove(replicate, "230213_")) %>%
left_join(adj_bmis_data) %>%
mutate(real_area = ifelse(is.na(adj_peak_area), num_area, adj_peak_area)) %>%
select(metabolite, replicate, bmis, real_area) %>%
mutate(bmis = replace_na(bmis, "None")) %>%
left_join(rfs) %>%
select(metabolite, replicate, bmis, real_area, rf_h2o, rf_mat, rf_ratio) %>%
mutate(uM = real_area/rf_h2o * 0.0004/2 * 1/rf_ratio) %>%
mutate(nM = uM*1000) %>%
## need to left_join with filt_data
# mutate(umol_in_enviro = umol_in_vial * 400 * 10e-6/2) %>%
na.omit() %>%
filter(!metabolite %in% ingalls_standards$internal_standards) %>%
filter(metabolite != "DL-Histidine, 15N") %>%
filter(nM > -0.01) %>%
filter(!str_detect(replicate, "Std"))
quant_data %>%
group_by(metabolite) %>%
mutate(mean_nm=mean(nM)) %>%
arrange(desc(mean_nm)) %>%
ungroup() %>%
mutate(metabolite = fct_inorder(metabolite)) %>%
ggplot(aes(y = metabolite, x = log10(nM))) +
geom_boxplot() +
theme_bw()
write.csv(quant_data, file = "csvs/quant_data.csv", row.names = FALSE)
write.csv(metadataframe, file = "csvs/metadataframe.csv", row.names = FALSE)
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(plotly)
library(vegan)
library(heatmaply)
set.seed(20)
quant_data <- read_csv("csvs/quant_data.csv") %>%
filter(nM > 0)
metadataframe <- read_csv("csvs/metadataframe.csv")
pcpn <- read_xlsx("metadata/peridice_pcpn.xlsx") %>%
select(tank = Tank, treatment = Treatment2, date = Date, pn = `PN (uM)`, pc = `PC (uM)`, cn = Cnratio) %>%
mutate(triplicate = str_extract(tank, "\\d"))
View(quant_data)
quant_data <- read_csv("csvs/quant_data.csv") %>%
filter(nM > 0 | nM < 100)
View(quant_data)
quant_data <- read_csv("csvs/quant_data.csv") %>%
filter(nM > 0) %>%
filter(nM < 100)
View(quant_data)
metadataframe <- read_csv("csvs/metadataframe.csv")
pcpn <- read_xlsx("metadata/peridice_pcpn.xlsx") %>%
select(tank = Tank, treatment = Treatment2, date = Date, pn = `PN (uM)`, pc = `PC (uM)`, cn = Cnratio) %>%
mutate(triplicate = str_extract(tank, "\\d"))
data_vis <- quant_data %>%
mutate(treatment = str_extract(replicate, "Std|Poo|Blk|C|ZF|ZL|ZH|RL|RH|LL|LH|Tote")) %>%
mutate(timepoint = str_extract(replicate, "27June|30June|14July|21July|27July")) %>%
mutate(timepoint = str_replace_all(timepoint, "July", "-7-22")) %>%
mutate(timepoint = str_replace_all(timepoint, "June", "-6-22")) %>%
mutate(date = as.Date(timepoint, format = "%d-%m-%y")) %>%
select(metabolite, treatment, date, nM, replicate) %>%
filter(metabolite != "Sodium 2-mercaptoethanesulfonate") %>%
filter(metabolite != "Fumaric acid") %>%
na.omit() %>%
mutate(triplicate = str_extract(replicate, "\\d$"))
level_order <- c("T0", "C", "ZF", "ZL", "ZH", "LL", "LH", "RL", "RH")
heat_level_order_treat <- c("2022-06-27 Tote", "2022-06-30 C",  "2022-07-14 C",  "2022-07-21 C",  "2022-07-27 C",
"2022-06-30 ZF", "2022-07-14 ZF", "2022-07-21 ZF", "2022-07-27 ZF",
"2022-06-30 ZL", "2022-07-14 ZL", "2022-07-21 ZL", "2022-07-27 ZL",
"2022-06-30 ZH", "2022-07-14 ZH", "2022-07-21 ZH", "2022-07-27 ZH",
"2022-06-30 LL", "2022-07-14 LL", "2022-07-21 LL", "2022-07-27 LL",
"2022-06-30 LH", "2022-07-14 LH", "2022-07-21 LH", "2022-07-27 LH",
"2022-06-30 RL", "2022-07-14 RL", "2022-07-21 RL", "2022-07-27 RL",
"2022-06-30 RH", "2022-07-14 RH", "2022-07-21 RH", "2022-07-27 RH")
heat_level_order_date <- c("2022-06-27 Tote", "2022-06-30 C","2022-06-30 ZF", "2022-06-30 ZL",
"2022-06-30 ZH", "2022-06-30 LL","2022-06-30 LH", "2022-06-30 RL", "2022-06-30 RH",
"2022-07-14 C", "2022-07-14 ZF", "2022-07-14 ZL", "2022-07-14 ZH", "2022-07-14 LL",
"2022-07-14 LH", "2022-07-14 RL", "2022-07-14 RH",
"2022-07-21 C", "2022-07-21 ZF", "2022-07-21 ZL", "2022-07-21 ZH",
"2022-07-21 LL", "2022-07-21 LH", "2022-07-21 RL", "2022-07-21 RH",
"2022-07-27 C", "2022-07-27 ZF", "2022-07-27 ZL",
"2022-07-27 ZH", "2022-07-27 LL", "2022-07-27 LH", "2022-07-27 RL",  "2022-07-27 RH")
pcpn %>%
mutate(cn_rank=(cn-min(cn))/(max(cn)-min(cn))) %>%
filter(str_detect(treatment, "RH|RL|LH|LL|C")) %>%
group_by(triplicate, treatment, date) %>%
# mutate(avg_cn = mean(cn)) %>%
# filter(triplicate == 2) %>%
ggplot(aes(x = date, y = cn, group = interaction(treatment, triplicate), color = treatment)) +
geom_line() +
geom_point() +
# scale_color_manual(values = c("plum2", "gold", "lightcoral", "darkorange", "brown3"), name = "Treatment") +
facet_wrap(~treatment) +
theme_bw() +
ylab("C to N Ratio") +
xlab("Date")
pcpn %>%
mutate(pc_rank=(pc-min(pc))/(max(pc)-min(pc))) %>%
filter(!str_detect(treatment, "Tote")) %>%
group_by(triplicate, treatment, date) %>%
# mutate(avg_cn = mean(cn)) %>%
# filter(triplicate == 2) %>%
ggplot(aes(x = date, y = pc, group = interaction(treatment, triplicate), color = treatment)) +
geom_line() +
geom_point() +
# scale_color_manual(values = c("plum2", "gold", "lightcoral", "darkorange", "brown3"), name = "Treatment") +
facet_wrap(~treatment, scales = "free") +
theme_bw() +
ylab("Particulate Carbon") +
xlab("Date")
quant_nmds_heat <- data_vis %>%
group_by(metabolite, treatment, date) %>%
summarise(avg_nmol = mean(nM)) %>%
ungroup() %>%
mutate(id = paste(date, treatment))
# %>%
#   filter(str_detect(treatment, "RH|RL|LH|LL"))
heatmap_data <- quant_nmds_heat %>%
# group_by(metabolite) %>%
# filter(str_detect(treatment, "RH|RL|C|Tote")) %>%
# filter(avg_nmol >= 0.01) %>%
complete(metabolite, id, fill = list(avg_nmol = 0)) %>%
group_by(metabolite) %>%
# mutate(norm_conc = rank(avg_nmol)) %>%
mutate(norm_conc=scale(avg_nmol)[,1]) %>%
select(metabolite, norm_conc, id) %>%
pivot_wider(names_from = "metabolite", values_from = "norm_conc") %>%
mutate(id=factor(id, levels=c(heat_level_order_treat))) %>%
arrange(id) %>%
column_to_rownames("id")
plotheatmap <- heatmap_data %>%
data.matrix() %>%
# heatmaply(fontsize_row = 10, fontsize_col = 7) %>%
heatmaply(Rowv = FALSE, fontsize_row = 10, fontsize_col = 7)
# make clustered heatmap from scratch using pheatmap
plotheatmap
data_vis_km <- data_vis %>%
pivot_wider(names_from = metabolite, values_from = nM) %>%
select(-c("treatment", "date")) %>%
column_to_rownames("replicate") %>%
data.matrix() %>%
`[<-`(is.na(.), 0) %>%
scale() %>%
t() %>%
kmeans(centers = 6) %>%
pluck("cluster") %>%
as.data.frame() %>%
set_names("cluster") %>%
rownames_to_column("metabolite")
data_vis_cluster <- data_vis_fc %>%
left_join(data_vis_km) %>%
rename(control = C, treatment = name, nM = value) %>%
mutate(cluster = factor(cluster))
data_vis_fc <- data_vis %>%
select(-c("replicate")) %>%
filter(!str_detect(treatment, "Tote")) %>%
pivot_wider(names_from = treatment, values_from = nM, values_fn = mean) %>%
pivot_longer(cols = c(ZF, ZL, ZH, LL, LH, RL, RH)) %>%
mutate(fold_change = value/C)
data_vis_km <- data_vis %>%
pivot_wider(names_from = metabolite, values_from = nM) %>%
select(-c("treatment", "date")) %>%
column_to_rownames("replicate") %>%
data.matrix() %>%
`[<-`(is.na(.), 0) %>%
scale() %>%
t() %>%
kmeans(centers = 6) %>%
pluck("cluster") %>%
as.data.frame() %>%
set_names("cluster") %>%
rownames_to_column("metabolite")
data_vis_cluster <- data_vis_fc %>%
left_join(data_vis_km) %>%
rename(control = C, treatment = name, nM = value) %>%
mutate(cluster = factor(cluster))
ranked_conc <- quant_nmds_heat %>%
# group_by(metabolite) %>%
# filter(str_detect(treatment, "RH|RL|C|Tote")) %>%
# filter(avg_nmol >= 0.01) %>%
complete(metabolite, id, fill = list(avg_nmol = 0)) %>%
group_by(metabolite) %>%
mutate(norm_conc = rank(avg_nmol)) %>%
select(metabolite, norm_conc, id)
ranked_conc %>%
ggplot() +
geom_raster(aes(x = metabolite, y = id, fill = norm_conc)) +
theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) +
scale_fill_gradient2(low = "steelblue", mid = "grey90",
high = "goldenrod1", midpoint = 16.5,
breaks=c(0, 16.5, 33), labels=c(
"Very little of a given compound",
"Median compound abundance",
"Compound maximum"
)) +
new_scale_fill() +
geom_tile(aes(x=metabolite, y=-1.5, fill=cluster), height=3, data = data_vis_cluster) +
# scale_fill_discrete(guide="none") +
# theme_void() +
theme(legend.position = "top",
legend.key.width = unit(dev.size()[1] / 6, "inches"),
legend.text = element_text(size=8))
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(plotly)
library(vegan)
library(heatmaply)
set.seed(20)
ranked_conc <- quant_nmds_heat %>%
# group_by(metabolite) %>%
# filter(str_detect(treatment, "RH|RL|C|Tote")) %>%
# filter(avg_nmol >= 0.01) %>%
complete(metabolite, id, fill = list(avg_nmol = 0)) %>%
group_by(metabolite) %>%
mutate(norm_conc = rank(avg_nmol)) %>%
select(metabolite, norm_conc, id)
ranked_conc %>%
ggplot() +
geom_raster(aes(x = metabolite, y = id, fill = norm_conc)) +
theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) +
scale_fill_gradient2(low = "steelblue", mid = "grey90",
high = "goldenrod1", midpoint = 16.5,
breaks=c(0, 16.5, 33), labels=c(
"Very little of a given compound",
"Median compound abundance",
"Compound maximum"
)) +
new_scale_fill() +
geom_tile(aes(x=metabolite, y=-1.5, fill=cluster), height=3, data = data_vis_cluster) +
# scale_fill_discrete(guide="none") +
# theme_void() +
theme(legend.position = "top",
legend.key.width = unit(dev.size()[1] / 6, "inches"),
legend.text = element_text(size=8))
??new_scale_fill
library(ggnewscale)
ranked_conc %>%
ggplot() +
geom_raster(aes(x = metabolite, y = id, fill = norm_conc)) +
theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) +
scale_fill_gradient2(low = "steelblue", mid = "grey90",
high = "goldenrod1", midpoint = 16.5,
breaks=c(0, 16.5, 33), labels=c(
"Very little of a given compound",
"Median compound abundance",
"Compound maximum"
)) +
new_scale_fill() +
geom_tile(aes(x=metabolite, y=-1.5, fill=cluster), height=3, data = data_vis_cluster) +
# scale_fill_discrete(guide="none") +
# theme_void() +
theme(legend.position = "top",
legend.key.width = unit(dev.size()[1] / 6, "inches"),
legend.text = element_text(size=8))
data_vis_cluster %>%
na.omit() %>%
group_by(cluster, date, treatment) %>%
filter(str_detect(treatment, "RH|RL|LH|LL")) %>%
mutate(avg_fc = mean(fold_change)) %>%
ggplot(aes(x = date, y = log2(avg_fc), color = factor(treatment, levels = level_order))) +
geom_point() +
geom_line() +
theme_bw() +
facet_wrap(~cluster) +
scale_color_manual(values = c("gold", "lightcoral","orange", "brown3"),
labels = c("6N:1P, low dose added", "6N:1P, high dose added",
"16N:1P, low dose added", "16N:1P, high dose added"),
name = "Treatment") +
theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) +
ylab("Average Fold Change") +
xlab("Date")
data_vis_cluster %>%
na.omit() %>%
group_by(cluster, date, treatment) %>%
# filter(str_detect(treatment, "RH|RL|LH|LL")) %>%
mutate(avg_fc = mean(fold_change)) %>%
ggplot(aes(x = date, y = log2(avg_fc), color = factor(treatment, levels = level_order))) +
geom_point() +
geom_line() +
theme_bw() +
facet_wrap(~cluster) +
scale_color_manual(values = c("mediumpurple3","darkslategray2", "lightseagreen","gold", "lightcoral","orange", "brown3"),
labels = c("0N:1P, low dose Fe","0N:1P, low dose added", "0N:1P, high dose added",
"6N:1P, low dose added", "6N:1P, high dose added",
"16N:1P, low dose added", "16N:1P, high dose added"),
name = "Treatment") +
theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) +
ylab("Average Fold Change") +
xlab("Date")
quant_nmds <- data_vis %>%
# arrange(desc(nM)) %>%
# group_by(metabolite, replicate) %>%
# slice(1) %>%
group_by(metabolite, treatment, date) %>%
summarise(avg_nmol = mean(nM)) %>%
ungroup() %>%
# complete(metabolite, date, treatment) %>%
# mutate(avg_nmol = replace_na(avg_nmol, 0)) %>%
mutate(id = paste(date, treatment)) %>%
filter(!str_detect(id, "Tote|ZF|ZH|ZL"))
quant_mat <- quant_nmds %>%
group_by(metabolite) %>%
mutate(norm_conc = rank(avg_nmol)) %>%
select(metabolite, norm_conc, id) %>%
pivot_wider(names_from = "metabolite", values_from = "norm_conc", values_fill = 0) %>%
column_to_rownames("id") %>%
data.matrix()
mdsout <- quant_mat %>%
metaMDS(k = 2, autotransform = FALSE)
mds_data <- metadataframe %>%
ungroup() %>%
mutate(timepoint = str_replace_all(timepoint, "July", "-7-22")) %>%
mutate(timepoint = str_replace_all(timepoint, "June", "-6-22")) %>%
mutate(date = as.Date(timepoint, format = "%d-%m-%y")) %>%
filter(str_detect(filename, "Smp")) %>%
mutate(treatment = str_remove(treatment, "\\d")) %>%
mutate(id = paste(date, treatment))
# %>%
#   select(-c("replicate", "filename"))
mdsout$points %>%
as.data.frame() %>%
rownames_to_column("id") %>%
left_join(mds_data) %>%
mutate(date_fct = factor(date)) %>%
ggplot() +
geom_point(aes(x=MDS1, y=MDS2, color=treatment, shape = date_fct), size=4) +
scale_color_manual(values = c("plum2", "lightcoral", "gold", "brown3", "orange", "mediumpurple3",
"lightseagreen", "darkslategray2"),
labels = c("Control - no nutrients added", "6N:1P, high dose added", "6N:1P, low dose added",
"16N:1P, high dose added", "16N:1P, low dose added", "0N:1P:0Fe, high dose added",
"0N:1P, low dose added", "0N:1P, high dose added"),
name = "Treatment") +
scale_shape_discrete(name = "Date") +
theme_bw() +
ggtitle("Variation of Metabolite Concentration (nM) Across Treatments")
quant_nmds <- data_vis %>%
# arrange(desc(nM)) %>%
# group_by(metabolite, replicate) %>%
# slice(1) %>%
group_by(metabolite, treatment, date) %>%
summarise(avg_nmol = mean(nM)) %>%
ungroup() %>%
# complete(metabolite, date, treatment) %>%
# mutate(avg_nmol = replace_na(avg_nmol, 0)) %>%
mutate(id = paste(date, treatment)) %>%
filter(!str_detect(treatment, "Tote"))
quant_mat <- quant_nmds %>%
group_by(metabolite) %>%
mutate(norm_conc = rank(avg_nmol)) %>%
select(metabolite, norm_conc, id) %>%
pivot_wider(names_from = "metabolite", values_from = "norm_conc", values_fill = 0) %>%
column_to_rownames("id") %>%
data.matrix()
mdsout <- quant_mat %>%
metaMDS(k = 2, autotransform = FALSE)
mds_data <- metadataframe %>%
ungroup() %>%
mutate(timepoint = str_replace_all(timepoint, "July", "-7-22")) %>%
mutate(timepoint = str_replace_all(timepoint, "June", "-6-22")) %>%
mutate(date = as.Date(timepoint, format = "%d-%m-%y")) %>%
filter(str_detect(filename, "Smp")) %>%
mutate(treatment = str_remove(treatment, "\\d")) %>%
mutate(id = paste(date, treatment))
mdsout$points %>%
as.data.frame() %>%
rownames_to_column("id") %>%
left_join(mds_data) %>%
mutate(date_fct = factor(date)) %>%
ggplot() +
geom_point(aes(x=MDS1, y=MDS2, color=factor(treatment, levels = level_order), shape = date_fct), size=4) +
scale_color_manual(values = c("plum2","mediumpurple3","darkslategray2", "lightseagreen","gold", "lightcoral","orange", "brown3"),
labels = c("Control","0N:1P, low dose Fe","0N:1P, low dose added", "0N:1P, high dose added",
"6N:1P, low dose added", "6N:1P, high dose added",
"16N:1P, low dose added", "16N:1P, high dose added"),
name = "Treatment") +
scale_shape_discrete(name = "Date") +
theme_bw() +
ggtitle("Variation of Metabolite Concentration (nM) Across Treatments")
